import botocore
import flask_mongoengine
from mongoengine import NotUniqueError, FieldDoesNotExist

from core.createSession.giveMeClient import giveMeClient
import sys
from core.database.models import AWSLambda
from flask_mongoengine import DoesNotExist

author = {
    "name": "gl4ssesbo1",
    "twitter": "https://twitter.com/gl4ssesbo1",
    "github": "https://github.com/gl4ssesbo1",
    "blog": "https://www.pepperclipp.com/"
}

needs_creds = True

variables = {
    "SERVICE": {
        "value": "s3",
        "required": "true",
        "description": "The service that will be used to run the module. It cannot be changed."
    },
    "BUCKET-NAME": {
        "value": "",
        "required": "true",
        "description": "The name of the bucket to download"
    },
    "KEY-NAME": {
        "value": "",
        "required": "false",
        "description": "The name of the key to be downloaded"
    },
    "KEY-VERSION": {
        "value": "",
        "required": "false",
        "description": "The version of the key to be downloaded"
    }
}
description = "Get a deleted file by the version id."

aws_command = ""

def exploit(profile, workspace):
    bucketname = variables['BUCKET-NAME']['value']
    keyname = variables['KEY-NAME']['value']
    keyversion = variables['KEY-VERSION']['value']

    try:
        response = profile.get_object(
                Bucket=bucketname,
                Key=keyname,
                VersionId=keyversion,

            )

        return {"Status": f"Key {keyname} was downloaded", "Body": response['Body'].read().decode('utf-8')}

    except Exception as e:
        return {"error": str(e)}
